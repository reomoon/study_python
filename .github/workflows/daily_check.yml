name: ğŸ Daily Python Study Check

on:
  # push:
  #   branches: ['study/**']  # study/ ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë¸Œëœì¹˜
  # pull_request:
  #   branches: ['main']
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: ['study/**']  # study/ ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë¸Œëœì¹˜
  pull_request:
    branches: ['main']
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  python-teacher:
    runs-on: ubuntu-latest
    name: ğŸ¤– AI Python Teacher
    
    steps:
    - name: ğŸ“š Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ëª¨ë“  ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ê¸°
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pytest
    
    - name: ğŸ” Check All Study Branches
      run: |
        echo "ğŸ” Checking all study branches..."
        git branch -r | grep "origin/study/" | while read branch; do
          branch_name=${branch#origin/}
          echo "ğŸ“‚ Checking branch: $branch_name"
          git checkout $branch_name 2>/dev/null || continue
          
          # ë¸Œëœì¹˜ë³„ ë¦¬í¬íŠ¸ ìƒì„±
          echo "## ğŸ“Š Study Report for $branch_name" >> report_${branch_name//\//_}.md
          echo "**Date**: $(date)" >> report_${branch_name//\//_}.md
          echo "" >> report_${branch_name//\//_}.md
          
          # Python íŒŒì¼ë“¤ ê²€ì‚¬
          for pyfile in week*.py; do
            if [ -f "$pyfile" ]; then
              echo "### ğŸ“ $pyfile" >> report_${branch_name//\//_}.md
              
              # 1. ë¬¸ë²• ê²€ì‚¬
              echo "#### ğŸ”§ ë¬¸ë²• ê²€ì‚¬" >> report_${branch_name//\//_}.md
              if python -m py_compile "$pyfile" 2>/dev/null; then
                echo "âœ… ë¬¸ë²• ì˜¤ë¥˜ ì—†ìŒ" >> report_${branch_name//\//_}.md
              else
                echo "âŒ ë¬¸ë²• ì˜¤ë¥˜ ë°œê²¬" >> report_${branch_name//\//_}.md
                python -m py_compile "$pyfile" 2>&1 | head -5 >> report_${branch_name//\//_}.md
              fi
              
              # 2. ìŠ¤íƒ€ì¼ ê²€ì‚¬ (flake8)
              echo "#### ğŸ¨ ì½”ë“œ ìŠ¤íƒ€ì¼" >> report_${branch_name//\//_}.md
              if flake8 "$pyfile" --max-line-length=88 --ignore=E203,W503 2>/dev/null; then
                echo "âœ… PEP8 ìŠ¤íƒ€ì¼ ì¤€ìˆ˜" >> report_${branch_name//\//_}.md
              else
                echo "âš ï¸ ìŠ¤íƒ€ì¼ ê°œì„  í•„ìš”:" >> report_${branch_name//\//_}.md
                flake8 "$pyfile" --max-line-length=88 --ignore=E203,W503 2>/dev/null | head -5 >> report_${branch_name//\//_}.md
              fi
              
              # 3. ì½”ë“œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
              echo "#### ğŸƒ ì‹¤í–‰ í…ŒìŠ¤íŠ¸" >> report_${branch_name//\//_}.md
              if timeout 10s python "$pyfile" >/dev/null 2>&1; then
                echo "âœ… ì½”ë“œ ì •ìƒ ì‹¤í–‰" >> report_${branch_name//\//_}.md
              else
                echo "âŒ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ" >> report_${branch_name//\//_}.md
              fi
              
              # 4. ì£¼ì„ í’ˆì§ˆ ê²€ì‚¬
              echo "#### ğŸ’¬ ì£¼ì„ í’ˆì§ˆ ê²€ì‚¬" >> report_${branch_name//\//_}.md
              
              # ì „ì²´ ë¼ì¸ ìˆ˜ì™€ ì£¼ì„ ë¼ì¸ ìˆ˜ ê³„ì‚°
              total_lines=$(wc -l < "$pyfile")
              comment_lines=$(grep -c '^[[:space:]]*#' "$pyfile" || echo 0)
              code_lines=$(grep -c '^[[:space:]]*[^#[:space:]]' "$pyfile" || echo 0)
              
              # ì£¼ì„ ë¹„ìœ¨ ê³„ì‚° (ì†Œìˆ˜ì  ì—†ì´)
              if [ $code_lines -gt 0 ]; then
                comment_ratio=$((comment_lines * 100 / code_lines))
              else
                comment_ratio=0
              fi
              
              echo "- ì „ì²´ ë¼ì¸: $total_lines" >> report_${branch_name//\//_}.md
              echo "- ì£¼ì„ ë¼ì¸: $comment_lines" >> report_${branch_name//\//_}.md
              echo "- ì½”ë“œ ë¼ì¸: $code_lines" >> report_${branch_name//\//_}.md
              echo "- ì£¼ì„ ë¹„ìœ¨: ${comment_ratio}%" >> report_${branch_name//\//_}.md
              
              # ì£¼ì„ í’ˆì§ˆ í‰ê°€
              if [ $comment_ratio -ge 15 ]; then
                echo "âœ… ì£¼ì„ì´ ì¶©ë¶„í•©ë‹ˆë‹¤! ì½”ë“œ ì´í•´ì— ë„ì›€ì´ ë˜ê² ì–´ìš”." >> report_${branch_name//\//_}.md
              elif [ $comment_ratio -ge 8 ]; then
                echo "ğŸ‘ ì ë‹¹í•œ ì£¼ì„ì´ ìˆë„¤ìš”. ì¡°ê¸ˆ ë” ì¶”ê°€í•˜ë©´ ë” ì¢‹ì„ ê²ƒ ê°™ì•„ìš”." >> report_${branch_name//\//_}.md
              elif [ $comment_ratio -ge 3 ]; then
                echo "ğŸ’¡ ì£¼ì„ì„ ì¡°ê¸ˆ ë” ì¶”ê°€í•´ë³´ì„¸ìš”." >> report_${branch_name//\//_}.md
              else
                echo "ğŸ“ ê°„ë‹¨í•œ ì„¤ëª… ì£¼ì„ì„ 1-2ê°œ ì¶”ê°€í•´ë³´ì„¸ìš”!" >> report_${branch_name//\//_}.md
              fi
              
              # ì˜ë¯¸ ìˆëŠ” ì£¼ì„ ê²€ì‚¬ (ë‹¨ìˆœ ë°˜ë³µì´ ì•„ë‹Œ)
              meaningful_comments=$(grep '^[[:space:]]*#' "$pyfile" | grep -v '^[[:space:]]*#[[:space:]]*$' | grep -v '^[[:space:]]*# ë‹µì„ ì•„ë˜ì— ì‘ì„±í•˜ì„¸ìš”' | wc -l || echo 0)
              
              if [ $meaningful_comments -ge 2 ]; then
                echo "âœ¨ ì˜ë¯¸ ìˆëŠ” ì£¼ì„ë“¤ì´ ì˜ ì‘ì„±ë˜ì–´ ìˆì–´ìš”!" >> report_${branch_name//\//_}.md
              elif [ $meaningful_comments -ge 1 ]; then
                echo "ğŸ’¡ ì˜ë¯¸ ìˆëŠ” ì£¼ì„ì´ ìˆë„¤ìš”. ì¢‹ìŠµë‹ˆë‹¤!" >> report_${branch_name//\//_}.md
              else
                echo "ğŸ“ ê°„ë‹¨í•œ ì„¤ëª… ì£¼ì„ì„ 1-2ê°œ ì¶”ê°€í•´ë³´ì„¸ìš”!" >> report_${branch_name//\//_}.md
              fi
              
              echo "" >> report_${branch_name//\//_}.md
            fi
          done
          
          # ì£¼ì°¨ë³„ ì§„ë„ ì²´í¬
          completed_weeks=0
          for week in {1..5}; do
            if [ -f "week${week}_*.py" ]; then
              # íŒŒì¼ì— ì‹¤ì œ ë‹µì•ˆì´ ìˆëŠ”ì§€ ì²´í¬ (ì£¼ì„ì´ ì•„ë‹Œ ì½”ë“œ ë¼ì¸)
              if grep -v '^#' week${week}_*.py | grep -q '[a-zA-Z]'; then
                completed_weeks=$((completed_weeks + 1))
              fi
            fi
          done
          
          echo "### ğŸ“ˆ í•™ìŠµ ì§„ë„" >> report_${branch_name//\//_}.md
          echo "ì™„ë£Œí•œ ì£¼ì°¨: $completed_weeks/5" >> report_${branch_name//\//_}.md
          echo "ì§„ë„ìœ¨: $(($completed_weeks * 20))%" >> report_${branch_name//\//_}.md
          
          # ê²©ë ¤ ë©”ì‹œì§€
          echo "### ğŸ¯ AI ì„ ìƒë‹˜ì˜ í•œë§ˆë””" >> report_${branch_name//\//_}.md
          if [ $completed_weeks -eq 0 ]; then
            echo "ğŸŒ± ì‹œì‘ì´ ë°˜ì…ë‹ˆë‹¤! ì²« ë²ˆì§¸ ë¬¸ì œë¶€í„° ì°¨ê·¼ì°¨ê·¼ í’€ì–´ë³´ì„¸ìš”." >> report_${branch_name//\//_}.md
          elif [ $completed_weeks -le 2 ]; then
            echo "ğŸ‘ ì¢‹ì€ ì‹œì‘ì´ì—ìš”! ê¾¸ì¤€íˆ í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤." >> report_${branch_name//\//_}.md
          elif [ $completed_weeks -le 4 ]; then
            echo "ğŸ”¥ ì˜ í•˜ê³  ìˆì–´ìš”! ì´ ì†ë„ë¡œ ê³„ì† ì§„í–‰í•˜ì„¸ìš”!" >> report_${branch_name//\//_}.md
          else
            echo "ğŸ† í›Œë¥­í•©ë‹ˆë‹¤! ëª¨ë“  ê³¼ì •ì„ ì™„ì£¼í•˜ì…¨ë„¤ìš”. ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì¤€ë¹„í•´ë³¼ê¹Œìš”?" >> report_${branch_name//\//_}.md
          fi
          
          echo "" >> report_${branch_name//\//_}.md
        done
    
    - name: ğŸ“Š Generate Overall Report
      run: |
        echo "# ğŸ“Š Daily Study Report - $(date +%Y-%m-%d)" > daily_report.md
        echo "" >> daily_report.md
        echo "## ğŸ¯ ì˜¤ëŠ˜ì˜ í•™ìŠµ í˜„í™©" >> daily_report.md
        echo "" >> daily_report.md
        
        # ê°œë³„ ë¦¬í¬íŠ¸ í•©ì¹˜ê¸°
        for report in report_study_*.md; do
          if [ -f "$report" ]; then
            cat "$report" >> daily_report.md
            echo "---" >> daily_report.md
          fi
        done
        
        echo "## ğŸ“¢ ê³µì§€ì‚¬í•­" >> daily_report.md
        echo "- ë§¤ì¼ ì˜¤í›„ 6ì‹œì— ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ ì²´í¬í•©ë‹ˆë‹¤" >> daily_report.md
        echo "- ì§ˆë¬¸ì´ ìˆìœ¼ë©´ Issuesì— ë‚¨ê²¨ì£¼ì„¸ìš”" >> daily_report.md
        echo "- íŒ€ì›ë“¤ì˜ ì½”ë“œë¥¼ ì°¸ê³ í•´ì„œ ì„œë¡œ ë°°ì›Œë³´ì„¸ìš”!" >> daily_report.md
    
    - name: ğŸ“ Create Issue with Report
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const reportContent = fs.readFileSync('daily_report.md', 'utf8');
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š ì¼ì¼ í•™ìŠµ ë¦¬í¬íŠ¸ - ${new Date().toLocaleDateString('ko-KR')}`,
            body: reportContent,
            labels: ['daily-report', 'study']
          });
    
    - name: ğŸ’Œ Comment on Push
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/study/')
      uses: actions/github-script@v7
      with:
        script: |
          // í‘¸ì‹œí•œ ë¸Œëœì¹˜ì— ëŒ€í•œ ì¦‰ì‹œ í”¼ë“œë°±
          const branchName = context.ref.replace('refs/heads/', '');
          const studentName = branchName.split('/')[1] || 'Student';
          
          const encouragements = [
            `ğŸ‰ ${studentName}ë‹˜, ìƒˆë¡œìš´ ì½”ë“œê°€ ì—…ë¡œë“œë˜ì—ˆë„¤ìš”! ì—´ì‹¬íˆ í•˜ëŠ” ëª¨ìŠµì´ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤.`,
            `ğŸ‘ ${studentName}ë‹˜ì˜ í•™ìŠµ ì—´ì •ì´ ëŠê»´ì§‘ë‹ˆë‹¤! ê³„ì† í™”ì´íŒ…í•˜ì„¸ìš”!`,
            `ğŸš€ ${studentName}ë‹˜, í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°€ì…¨ë„¤ìš”. ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì…ë‹ˆë‹¤!`,
            `â­ ${studentName}ë‹˜, ì˜¤ëŠ˜ë„ ì„±ì‹¤í•˜ê²Œ ê³µë¶€í•˜ì‹œëŠ”êµ°ìš”. ì‘ì›í•©ë‹ˆë‹¤!`
          ];
          
          const randomMessage = encouragements[Math.floor(Math.random() * encouragements.length)];
          
          // ìµœê·¼ ì»¤ë°‹ì— ì½”ë©˜íŠ¸ ë‹¬ê¸°
          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `${randomMessage}\n\nğŸ¤– ìë™í™”ëœ ì²´í¬ê°€ ì™„ë£Œë˜ë©´ ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí• ê²Œìš”!`
          });
